#
# This file is here to build 2 docker images : locokit-api & locokit-app
#
# This docker file is only for GitHub Action
#
# Please don't use in local development
#
# It needs other jobs in the CI/CD to be already done to retrieve artifacts
#

#
# Base image
#
# To be used by all others images
#
FROM node:18-alpine AS base
RUN apk add --no-cache libc6-compat nano
RUN apk update
RUN npm i -g --ignore-scripts pnpm pm2
RUN addgroup -S locokit \
    && adduser -S locokit -G locokit

# Environment variables default values
ENV NODE_ENV=production

#
# LocoKit API image
# Koa NodeJS web server for the Feathers API
#
FROM base AS locokit-api
WORKDIR /code
COPY api/package.json /code/api/
COPY packages/definitions/package.json /code/packages/definitions/
COPY packages/engine/package.json /code/packages/engine/
COPY package.json .
COPY pnpm-lock.yaml .
COPY pnpm-workspace.yaml ./
RUN pnpm i --frozen-lockfile --ignore-scripts --prod
COPY api/dist /code/api
COPY packages/definitions/dist /code/packages/definitions/dist
COPY packages/engine/dist /code/packages/engine/dist

USER locokit
WORKDIR /code/api
CMD pm2 start index.mjs

#
# LocoKit APP image
# nginx serving static files
#
FROM nginx:alpine AS locokit-app
COPY app/dist/ /etc/nginx/html
