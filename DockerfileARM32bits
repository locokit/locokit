#
# This file is here to build 2 docker images : locokit-api & locokit-app
#
# This docker file can work for both amd64 and arm32/64 platforms (v6, v7, v8)
# as it doesn't use turbo (https://turbo.build/)
#
# Indeed, turbo doesn't work for arm32 platforms
# see https://github.com/vercel/turbo/issues/4935
#

#
# Base image
#
# To be used by all others images
#
FROM node:18-alpine AS base
RUN apk add --no-cache libc6-compat nano
RUN apk update
RUN npm i -g --ignore-scripts pnpm pm2
RUN addgroup -S locokit \
    && adduser -S locokit -G locokit

# Environment variables default values
ENV NODE_ENV=production

#
# Builder image
#
# Used to build all locokit packages
#
FROM base AS builder
# we need to install all dependencies for building purpose
ENV NODE_ENV=dev
WORKDIR /code
COPY *.json ./
COPY pnpm-lock.yaml ./
COPY pnpm-workspace.yaml ./
COPY api api
# COPY app app
COPY docs docs
COPY packages packages
RUN pnpm i --ignore-scripts
RUN pnpm --filter @locokit/definitions build
RUN pnpm --filter @locokit/designsystem build
RUN pnpm --filter @locokit/engine build
RUN pnpm --filter nuxt-locokit nuxt:prepare
RUN pnpm --filter nuxt-locokit build
RUN pnpm --filter locokit-api build
RUN pnpm --filter @locokit/sdk build
# RUN pnpm run build --workspace app

#
# LocoKit API image
# Koa NodeJS web server for the Feathers API
#
FROM base AS locokit-api
WORKDIR /code
COPY --from=builder /code/api/package.json /code/api/
COPY --from=builder /code/packages/definitions/package.json /code/packages/definitions/
COPY --from=builder /code/packages/engine/package.json /code/packages/engine/
COPY --from=builder /code/package.json .
COPY --from=builder /code/pnpm-lock.yaml .
COPY --from=builder /code/pnpm-workspace.yaml .
RUN pnpm i --frozen-lockfile --ignore-scripts --prod
COPY --from=builder /code/api/dist /code/api
COPY --from=builder /code/packages/definitions/dist /code/packages/definitions/dist
COPY --from=builder /code/packages/engine/dist /code/packages/engine/dist

USER locokit
WORKDIR /code/api
CMD pm2 start index.mjs

#
# LocoKit APP image
# Nitro web server for the Nuxt application
#
FROM base AS locokit-app
WORKDIR /code
# COPY --from=builder /code/app/.output .
COPY --from=builder /code/packages/nuxt-locokit/playground/.output .

USER locokit
CMD pm2 start server/index.mjs

